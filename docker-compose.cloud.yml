version: '3.8'

services:
  # ═══════════════════════════════════════════════════════════
  # MCP Agent Servers (SSE Transport - Long-Running Services)
  # Using Cloud Neo4j Aura from .env
  # ═══════════════════════════════════════════════════════════

  orchestrator:
    build:
      context: .
      dockerfile: Dockerfile.orchestrator
    container_name: graphical-rag-orchestrator
    env_file:
      - .env
    environment:
      - ORCHESTRATOR_HOST=0.0.0.0
      - ORCHESTRATOR_PORT=8001
      # NEO4J_URI will be read from .env (cloud Neo4j Aura)
    ports:
      - "8001:8001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/sse"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - graphical-rag-network
    restart: unless-stopped

  indexer:
    build:
      context: .
      dockerfile: Dockerfile.indexer
    container_name: graphical-rag-indexer
    env_file:
      - .env
    environment:
      - INDEXER_HOST=0.0.0.0
      - INDEXER_PORT=8002
      # NEO4J_URI will be read from .env (cloud Neo4j Aura)
    ports:
      - "8002:8002"
    volumes:
      - indexer_repos:/app/repos  # Persist cloned repositories
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/sse"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - graphical-rag-network
    restart: unless-stopped

  graph_query:
    build:
      context: .
      dockerfile: Dockerfile.graph_query
    container_name: graphical-rag-graph-query
    env_file:
      - .env
    environment:
      - GRAPH_QUERY_HOST=0.0.0.0
      - GRAPH_QUERY_PORT=8003
      # NEO4J_URI will be read from .env (cloud Neo4j Aura)
    ports:
      - "8003:8003"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/sse"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - graphical-rag-network
    restart: unless-stopped

  code_analyst:
    build:
      context: .
      dockerfile: Dockerfile.code_analyst
    container_name: graphical-rag-code-analyst
    env_file:
      - .env
    environment:
      - CODE_ANALYST_HOST=0.0.0.0
      - CODE_ANALYST_PORT=8004
      # NEO4J_URI will be read from .env (cloud Neo4j Aura)
    ports:
      - "8004:8004"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/sse"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - graphical-rag-network
    restart: unless-stopped

  # ═══════════════════════════════════════════════════════════
  # FastAPI Gateway
  # ═══════════════════════════════════════════════════════════
  gateway:
    build:
      context: .
      dockerfile: Dockerfile.gateway
    container_name: graphical-rag-gateway
    env_file:
      - .env
    environment:
      - GATEWAY_HOST=0.0.0.0
      - GATEWAY_PORT=8000
      # NEO4J_URI will be read from .env (cloud Neo4j Aura)
      # Agent URLs for SSE transport connection
      - ORCHESTRATOR_URL=http://orchestrator:8001/sse
      - INDEXER_URL=http://indexer:8002/sse
      - GRAPH_QUERY_URL=http://graph_query:8003/sse
      - CODE_ANALYST_URL=http://code_analyst:8004/sse
    ports:
      - "${GATEWAY_PORT:-8000}:8000"
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/api/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - graphical-rag-network
    restart: unless-stopped

# ═══════════════════════════════════════════════════════════
# Volumes
# ═══════════════════════════════════════════════════════════
volumes:
  indexer_repos:
    driver: local

# ═══════════════════════════════════════════════════════════
# Networks
# ═══════════════════════════════════════════════════════════
networks:
  graphical-rag-network:
    driver: bridge
